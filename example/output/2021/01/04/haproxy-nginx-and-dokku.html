<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

	<title>David Díaz  | Haproxy, Nginx and Dokku </title>

	<link rel="stylesheet" href="/css/screen.css">
	<link rel="alternate" type="application/rss+xml" title="RSS Feed for martianwabbit.com" href="https://martianwabbit.com/feed.xml" />
	<link rel="me" href="https://mastodon.social/@seich" />
</head>
<body>
<div id="top">
	<h1><a href="/">David Díaz<span>.</span></a></h1>
</div>

<header>
  <h1>
    <a href="">Haproxy, Nginx and Dokku</a>
  </h1>

  <aside>
    <time>Posted on: January 04, 2021</time>
    <span>327 Words</span>
    <span
      >Takes 2 minutes to read</span
    >
  </aside>
</header>
<article>
  <p>I just finished setting up a wordpress site for my sister over the past weekend.
I usually setup some plugins to automatically block bruteforce attempts on these
since they are so common. Everything went smooth as usual until I checked in on
it the next morning and found myself blocked. I checked the logs and it turns
out it banned the reverse proxy's ip.</p>
<p>I am using Haproxy as a reverse proxy / load balancer for the entire server but
the ssl is handled by dokku which means Haproxy runs in tcp mode and doesn't do
much other than route the traffic. Dokku also has a reverse proxy which it uses
to handle domains, it uses Nginx for this.</p>
<p>It turns out Haproxy can't add requests to an https request that terminates on a
different server. This makes sense but wasn't obvious from the get go, the easy
solution was to use the proxy protocol so that Haproxy and Nginx can agree on
which ip is which.</p>
<p>Here's how to do it:</p>
<p>First, we need to tell Haproxy to use the proxy protocol. All we have to do is
add <code>send-proxy</code> to the server option. This will send over all of the info Nginx
will need to find the correct ip.</p>
<pre><code>backend web
        mode tcp
        server web-http dokku send-proxy
</code></pre>
<p>Next we need to tell Nginx to actually use that info. This is done by adding the
<code>proxy_protocol</code> parameter to the listen option.</p>
<pre><code>server {
  listen      443 ssl proxy_protocol http2;
  ...
}
</code></pre>
<p>Finally, we need to set the request's <code>X-Forwarded-For</code> header to the real ip.
We can achieve this by adding a new conf file in
<code>/etc/nginx/conf.d/set_real_ip.conf</code>. You can name it whatever you want, it
should look something like this:</p>
<pre><code>set_real_ip_from  10.0.0.0/8;
set_real_ip_from  172.0.0.0/8;
real_ip_header proxy_protocol;
</code></pre>
<p>You should list off all of the proxies that are part of the chain here.
<code>proxy_protocol</code> will take care to set the <code>X-Forwarded-For</code> ip to the correct
value automatically.</p>

  <p class="comments">
    Have a comment? Feel free to
    <a href="mailto:seich@martianwabbit.com">email me</a>.<br />
    Did you enjoy this post?
    <a href="https://www.buymeacoffee.com/seich">Buy me a coffee ☕️</a>.
  </p>
</article>


<footer>
	<p>David Díaz © All Rights Reserved.</p>
</footer>
</body>
</html>
